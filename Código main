import discord, pyttsx3, requests, random
from discord.ext import commands, tasks # MÃ³dulo para controlar el bot basado en comandos

intents = discord.Intents.default()  # Configurar los permisos para el bot
intents.message_content = True  # Habilitar la capacidad de leer el contenido de los mensajes
bot = commands.Bot(command_prefix="!", intents=intents)  # Crear un bot con el prefijo de comando especificado
API_KEY = "d1c80db267d6867e0ada26429c402153"

@bot.event
async def on_ready():
    print("Estoy conectado y funcionando ðŸ˜Ž") #verificaciÃ³n del funcionamiento del bot

def obtener_clima(ciudad):
    url = f"http://api.openweathermap.org/data/2.5/weather?q={ciudad}&appid={API_KEY}&lang=es&units=metric"
    respuesta = requests.get(url)
    
    if respuesta.status_code == 200:
        datos = respuesta.json()
        clima = datos["weather"][0]["description"].capitalize()
        temperatura = datos["main"]["temp"]
        # Consejo divertido segÃºn la temperatura
        if temperatura < 15:
            consejo = "Hace frÃ­o , ponte un abrigo."
        elif temperatura < 25:
            consejo = "Clima agradable , disfruta tu dÃ­a."
        else:
            consejo = "Hace calor , toma mucha agua."
        return f"En **{ciudad}** estÃ¡ {clima} con {temperatura}Â°C.\n {consejo}"
    else:
        return "No encontrÃ© esa ciudad, intÃ©ntalo de nuevo."

@bot.command()
async def clima(ctx, *, ciudad: str = None):
    if ciudad is None:
        await ctx.send("Escribe una ciudad despuÃ©s de `!clima`, por ejemplo: `!clima BogotÃ¡`")
    else:
        clima_info = obtener_clima(ciudad)
        engine = pyttsx3.init()
        word = clima_info
        engine.say(word)
        engine.save_to_file(word, 'clima.mp3')
        engine.runAndWait()

        await ctx.send(clima_info)
        await ctx.send(file=discord.File('clima.mp3'))

# ----- MATERIALES Y SUS CONSEJOS -----
INFO_MATERIALES = {
    "papel": {
        "reciclable": True,
        "consejos": [
            "Usa ambos lados antes de botarlo.",
            "Convierte papeles viejos en notas pequeÃ±as.",
            "Haz origami como grullas, estrellas o flores.",
            "PÃ­ntalo y conviÃ©rtelo en tu propio papel de regalo."
        ]
    },

    "metal": {
        "reciclable": True,
        "consejos": [
            "Limpia las latas antes de reciclarlas.",
            "PÃ­salas para reducir su volumen.",
            "Haz una casita de pÃ¡jaros con una lata grande.",
            "Convierte las latas en macetas decoradas."
        ]
    },

    "vidrio": {
        "reciclable": True,
        "consejos": [
            "Enjuaga los frascos antes de reciclarlos.",
            "Convierte frascos en lÃ¡mparas con luces LED.",
            "Haz un mini terrario dentro de un frasco.",
            "Ãšsalos como potes para almacenar cosas."
        ]
    },

    "plÃ¡stico": {
        "reciclable": True,
        "consejos": [
            "Reduce el uso de botellas desechables.",
            "Reutiliza botellas para hacer macetas pequeÃ±as.",
            "Haz un comedero para pÃ¡jaros con una botella.",
            "Convierte botellas en portalÃ¡pices decorados."
        ]
    },

    "orgÃ¡nico": {
        "reciclable": False,
        "consejos": [
            "Convierte restos orgÃ¡nicos en compost para tus plantas.",
            "Haz abono natural con residuos de frutas y verduras.",
            "Utiliza cÃ¡scaras de huevo trituradas como fertilizante.",
            "Haz un pequeÃ±o lombricario casero para compostaje."
        ]
    },

    "baterÃ­a": {
        "reciclable": False,
        "consejos": [
            "LlÃ©valas a un punto de reciclaje especial, nunca las botes a la basura.",
            "GuÃ¡rdalas en un frasco hasta acumular varias y reciclarlas juntas.",
            "ReemplÃ¡zalas por baterÃ­as recargables.",
            "Evita dejarlas en lugares hÃºmedos porque pueden gotear quÃ­micos."
        ]
    },

    "cartÃ³n": {
        "reciclable": True,
        "consejos": [
            "AplÃ¡stalo para que ocupe menos espacio al reciclar.",
            "Convierte cajas en organizadores de escritorio.",
            "Haz una maqueta o diorama creativo con cartÃ³n.",
            "Transforma una caja en una casita o tÃºnel para tu mascota."
        ]
    }
}
# ----- FRASES AMBIENTALES PARA SPAM AUTOMÃTICO -----
FRASES_ECO = [
    "Â¿SabÃ­as que cada botella que tiras puede tardar 450 aÃ±os en desaparecer?",
    "Apagar una luz que no usas reduce contaminaciÃ³n al instante",
    "Reciclar una lata ahorra energÃ­a suficiente para encender un televisor por 3 horas",
    "Los ocÃ©anos estÃ¡n llenos de plÃ¡sticoâ€¦ ayudemos reduciendo su uso",
    "Caminar cuando puedas reduce tu huella de carbono y mejora tu salud",
    "Plantar Ã¡rboles ayuda a limpiar el aire que respiramos",
    "Cada tonelada de papel reciclado salva 17 Ã¡rboles",
    "Cerrar el caÃ±o mientras te cepillas ahorra hasta 30 litros de agua",
    "Un Ã¡rbol adulto puede absorber 22 kg de COâ‚‚ al aÃ±o",
    "El 91% del plÃ¡stico del mundo no se recicla",
    "Apagar tu computadora por la noche ahorra mucha energÃ­a",
    "Una ducha de 5 minutos usa menos agua que llenar una tina",
    "Los bosques producen el 40% del oxÃ­geno del planeta",
    "Usar una botella reutilizable evita cientos de desechables al aÃ±o",
    "El vidrio tarda mÃ¡s de 4,000 aÃ±os en descomponerse",
    "La contaminaciÃ³n del aire causa 7 millones de muertes al aÃ±o",
    "Elegir productos locales reduce emisiones de transporte",
    "Reciclar papel reduce un 70% de consumo de energÃ­a",
    "Un tercio de los alimentos se desperdicia cada aÃ±o",
    "El 80% de la basura en el mar proviene de actividades humanas",
    "Cada grado que bajas en la ducha ahorra energÃ­a",
    "Los ocÃ©anos absorben el 30% del COâ‚‚ que producimos",
    "Usar bolsas reutilizables evita 500 bolsas plÃ¡sticas por persona al aÃ±o",
    "El 75% de los residuos electrÃ³nicos NO se reciclan",
    "Cargar el celular consume menos energÃ­a que dejar el cargador enchufado",
    "La bicicleta es el transporte mÃ¡s ecolÃ³gico del mundo",
]

# ----- TAREA AUTOMÃTICA -----
@tasks.loop(minutes=25)  # cada 25 minutos
async def eco_spam():
    frase = random.choice(FRASES_ECO)

    for guild in bot.guilds:  # enviar a TODOS LOS SERVIDORES donde estÃ© el bot
        canal = guild.text_channels[0]  # primer canal del server

        # Genera audio
        engine = pyttsx3.init()
        engine.save_to_file(frase, "eco.mp3")
        engine.runAndWait()

        try:
            await canal.send(f"â™»ï¸ **Dato ecolÃ³gico:** {frase}")
            await canal.send(file=discord.File("eco.mp3"))
        except:
            pass  # por si el bot no puede escribir en ese canal

@bot.event
async def on_ready():
    print("Bot activo ðŸŒ±")
    eco_spam.start()

@bot.command() #Comando para obtener informaciÃ³n sobre materiales reciclables
async def material(ctx, *, nombre: str = None):

    if nombre is None:
        return await ctx.send("Escribe un material: `!material papel`, `!material plÃ¡stico`, etc.")

    nombre = nombre.lower()

    if nombre not in INFO_MATERIALES:
        return await ctx.send("No conozco ese material. Prueba con materiales como: papel, plÃ¡stico, vidrio, metal, orgÃ¡nico, baterÃ­a y cartÃ³n.")

    info = INFO_MATERIALES[nombre]

    reciclable = "SÃ­ es reciclable" if info["reciclable"] else "No es reciclable"

    consejo = random.choice(info["consejos"])

    texto = (
        f"**Material:** {nombre.capitalize()}\n"
        f"{reciclable}\n"
        f" *{consejo}*"
    )
    # Generar audio
    engine = pyttsx3.init()
    engine.save_to_file(texto, "material.mp3")
    engine.runAndWait()

    await ctx.send(texto)
    await ctx.send(file=discord.File("material.mp3"))

@bot.command()
async def comandos(ctx):
    print("Alguien pidiÃ³ la lista de comandos")
    texto = (
        "**Lista de comandos disponibles:**\n"
        "`!clima [ciudad]` - ObtÃ©n el clima actual de una ciudad.\n"
        "`!material [nombre del material]` - InformaciÃ³n y consejos sobre reciclaje de materiales.\n"
        "`!comandos` - Muestra esta lista de comandos."
    )
    # Generar audio
    engine = pyttsx3.init()
    engine.save_to_file(texto, "info.mp3")
    engine.runAndWait()

    await ctx.send(texto)
    await ctx.send(file=discord.File("info.mp3"))



bot.run("TU TOKEN")  # Reemplaza con el token de tu bot
